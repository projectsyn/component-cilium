parameters:

  =_helm_chart_name:
    opensource: cilium
    enterprise: cilium-enterprise
  =_kapitan:
    olm:
      dependencies:
        - type: https
          source: ${cilium:olm:source:${cilium:release}}
          output_path: dependencies/cilium/olm/cilium/cilium-olm/
          unpack: true

      compile:
        - input_paths:
            - cilium/component/app.jsonnet
          input_type: jsonnet
          output_path: apps/

        - input_paths:
            - cilium/component/olm.jsonnet
          input_type: jsonnet
          output_path: ${_instance}/olm/

    helm:
      dependencies:
        - type: helm
          chart_name: ${_helm_chart_name:${cilium:release}}
          version: ${cilium:charts:${_helm_chart_name:${cilium:release}}:version}
          source: ${cilium:charts:${_helm_chart_name:${cilium:release}}:source}
          output_path: dependencies/cilium/helmcharts/cilium/${cilium:release}/${cilium:charts:${_helm_chart_name:${cilium:release}}:version}/

      compile:
        - input_paths:
            - cilium/component/app.jsonnet
          input_type: jsonnet
          output_path: apps/

        - input_paths:
            - cilium/component/helm-namespace.jsonnet
          input_type: jsonnet
          output_path: ${_instance}/01_cilium_helmchart
        - output_path: ${_instance}/01_cilium_helmchart
          input_type: helm
          output_type: yaml
          input_paths:
            - cilium/helmcharts/cilium/${cilium:release}/${cilium:charts:${_helm_chart_name:${cilium:release}}:version}/
          helm_params:
            name: ${cilium:release_name}
            namespace: ${cilium:_namespace}
          helm_values: ${cilium:helm_values}

  kapitan:
    ${_kapitan:${cilium:install_method}}
